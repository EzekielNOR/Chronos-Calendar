<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Chronos">
    <title>Chronos</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0b;
            --bg-secondary: #111113;
            --bg-tertiary: #18181b;
            --bg-hover: #222225;
            --border-subtle: #27272a;
            --border-medium: #3f3f46;
            --text-primary: #fafafa;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --accent: #8b5cf6;
            --accent-hover: #a78bfa;
            --danger: #ef4444;
            --success: #22c55e;
            --today-bg: rgba(139, 92, 246, 0.15);
            --today-border: rgba(139, 92, 246, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            touch-action: manipulation;
        }

        body {
            font-family: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Global touch fixes for iOS */
        button, 
        [onclick],
        .day-cell,
        .event-item,
        .day-event-item,
        .briefing-event {
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
        }

        /* App Container */
        .app {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-subtle);
            flex-shrink: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo {
            font-family: 'JetBrains Mono', monospace;
            font-size: 18px;
            font-weight: 600;
            color: var(--accent);
            letter-spacing: -0.5px;
        }

        .month-nav {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn {
            width: 36px;
            height: 36px;
            border: 1px solid var(--border-subtle);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
        }

        .nav-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
            border-color: var(--border-medium);
        }

        .nav-btn:active {
            transform: scale(0.95);
        }

        .current-month {
            font-size: 20px;
            font-weight: 600;
            min-width: 180px;
            text-align: center;
        }

        .today-btn {
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
        }

        .today-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .agenda-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: linear-gradient(135deg, var(--accent) 0%, #7c3aed 100%);
            border: none;
            color: white;
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
        }

        .agenda-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }

        .agenda-btn:active {
            transform: translateY(0);
        }

        .agenda-btn .icon {
            width: 16px;
            height: 16px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sync-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        .sync-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .settings-btn {
            width: 40px;
            height: 40px;
            border: 1px solid var(--border-subtle);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
        }

        .settings-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        /* View Toggle */
        .view-toggle {
            display: flex;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            overflow: hidden;
        }

        .view-toggle-btn {
            padding: 8px 12px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            touch-action: manipulation;
        }

        .view-toggle-btn.active {
            background: var(--accent);
            color: white;
        }

        .view-toggle-btn:not(.active):hover {
            color: var(--text-primary);
            background: var(--bg-hover);
        }

        /* Search Button */
        .search-btn {
            width: 40px;
            height: 40px;
            border: 1px solid var(--border-subtle);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
            touch-action: manipulation;
        }

        .search-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        /* Search Modal */
        .search-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            display: none;
            align-items: flex-start;
            justify-content: center;
            z-index: 250;
            padding: 80px 24px 24px;
        }

        .search-modal.active {
            display: flex;
        }

        .search-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            max-height: 70vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .search-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .search-input-wrapper {
            flex: 1;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px 12px 44px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 15px;
            transition: all 0.15s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            color: var(--text-muted);
        }

        .search-results {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .search-result-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.15s ease;
            touch-action: manipulation;
        }

        .search-result-item:hover {
            background: var(--bg-hover);
        }

        .search-result-color {
            width: 4px;
            border-radius: 2px;
            flex-shrink: 0;
        }

        .search-result-info {
            flex: 1;
            min-width: 0;
        }

        .search-result-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .search-result-date {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--text-muted);
        }

        .search-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        /* Week View */
        .week-container {
            flex: 1;
            display: none;
            flex-direction: column;
            padding: 16px;
            overflow: hidden;
        }

        .week-container.active {
            display: flex;
        }

        .calendar-container.hidden {
            display: none;
        }

        .week-grid {
            display: flex;
            flex-direction: column;
            flex: 1;
            gap: 2px;
            min-height: 0;
        }

        .week-day-row {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 10px;
            flex: 1;
            min-height: 0;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.15s ease;
            touch-action: manipulation;
        }

        .week-day-row:hover {
            background: var(--bg-tertiary);
        }

        .week-day-row.today {
            background: var(--today-bg);
            border: 1px solid var(--today-border);
        }

        .week-day-info {
            width: 100px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .week-day-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .week-day-date {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .week-day-row.today .week-day-date {
            color: var(--accent);
        }

        .week-events {
            flex: 1;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-content: flex-start;
            overflow: hidden;
        }

        .week-event-chip {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            max-width: 100%;
            overflow: hidden;
        }

        .week-day-row.today .week-event-chip {
            background: var(--bg-secondary);
        }

        .week-event-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .week-event-time {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .week-event-title {
            font-size: 12px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Calendar Toggle in Settings */
        .calendar-toggle-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .calendar-toggle {
            position: relative;
            width: 40px;
            height: 22px;
            flex-shrink: 0;
        }

        .calendar-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .calendar-toggle-slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background: var(--bg-hover);
            border-radius: 11px;
            transition: 0.2s;
        }

        .calendar-toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background: var(--text-muted);
            border-radius: 50%;
            transition: 0.2s;
        }

        .calendar-toggle input:checked + .calendar-toggle-slider {
            background: var(--accent);
        }

        .calendar-toggle input:checked + .calendar-toggle-slider:before {
            transform: translateX(18px);
            background: white;
        }

        /* Reminder time selector */
        .reminder-section {
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--border-subtle);
        }

        .reminder-select {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.15s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2371717a'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 18px;
        }

        .reminder-select:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Calendar Grid */
        .calendar-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 16px;
            overflow: hidden;
        }

        .weekday-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 8px;
        }

        .weekday {
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 8px 0;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: repeat(6, 1fr);
            gap: 8px;
            flex: 1;
            min-height: 0;
        }

        .day-cell {
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.15s ease;
            min-height: 0;
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
        }

        .day-cell:hover {
            border-color: var(--border-medium);
            background: var(--bg-tertiary);
        }

        .day-cell.other-month {
            opacity: 0.4;
        }

        .day-cell.today {
            background: var(--today-bg);
            border-color: var(--today-border);
        }

        .day-number {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 6px;
            flex-shrink: 0;
        }

        .day-cell.today .day-number {
            color: var(--accent);
        }

        .events-list {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 3px;
            min-height: 0;
        }

        .event-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 3px 6px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .event-color {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .event-time {
            font-family: 'JetBrains Mono', monospace;
            font-size: 9px;
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .event-title {
            font-size: 10px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            min-width: 0;
        }

        .more-events {
            font-size: 9px;
            color: var(--text-muted);
            text-align: center;
            padding: 2px;
            flex-shrink: 0;
        }

        /* Settings Panel */
        .settings-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 24px;
        }

        .settings-overlay.active {
            display: flex;
        }

        .settings-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            width: 100%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .settings-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .settings-title {
            font-size: 18px;
            font-weight: 600;
        }

        .close-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
        }

        .close-btn:hover {
            background: var(--danger);
            color: white;
        }

        .settings-content {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .section-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .calendar-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 24px;
        }

        .calendar-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
        }

        .calendar-color-picker {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            padding: 0;
            background: transparent;
        }

        .calendar-color-picker::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        .calendar-color-picker::-webkit-color-swatch {
            border: 2px solid var(--border-medium);
            border-radius: 6px;
        }

        .calendar-info {
            flex: 1;
            min-width: 0;
        }

        .calendar-name-input {
            width: 100%;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .calendar-name-input:focus {
            outline: none;
        }

        .calendar-url {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .delete-cal-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
        }

        .delete-cal-btn:hover {
            background: var(--danger);
            color: white;
        }

        .add-calendar-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .input-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .text-input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 14px;
            transition: all 0.15s ease;
        }

        .text-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .text-input::placeholder {
            color: var(--text-muted);
        }

        .input-row {
            display: flex;
            gap: 12px;
        }

        .input-row .input-group:first-child {
            flex: 1;
        }

        .add-btn {
            padding: 12px 24px;
            background: var(--accent);
            border: none;
            border-radius: 10px;
            color: white;
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .add-btn:hover {
            background: var(--accent-hover);
        }

        .add-btn:active {
            transform: scale(0.98);
        }

        .privacy-notice {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-top: 24px;
            padding: 16px;
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.2);
            border-radius: 12px;
        }

        .privacy-icon {
            width: 20px;
            height: 20px;
            color: var(--success);
            flex-shrink: 0;
            margin-top: 2px;
        }

        .privacy-text {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 13px;
        }

        .privacy-text strong {
            color: var(--success);
        }

        .privacy-text span {
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .settings-footer {
            margin-top: 32px;
            padding-top: 20px;
            border-top: 1px solid var(--border-subtle);
            text-align: center;
        }

        .credits {
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.6;
        }

        .credits a {
            color: var(--accent);
            text-decoration: none;
            transition: color 0.15s ease;
        }

        .credits a:hover {
            color: var(--accent-hover);
        }

        .credits-name {
            font-weight: 500;
            color: var(--text-secondary);
        }

        .credits-company {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
        }

        /* Event Detail Modal */
        .event-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
            padding: 24px;
        }

        .event-modal.active {
            display: flex;
        }

        .event-detail {
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            width: 100%;
            max-width: 480px;
            overflow: hidden;
        }

        .event-detail-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .event-detail-title {
            font-size: 20px;
            font-weight: 600;
            padding-right: 16px;
        }

        .event-detail-content {
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .detail-row {
            display: flex;
            gap: 12px;
        }

        .detail-icon {
            width: 20px;
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .detail-text {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.5;
        }

        .detail-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .calendar-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            font-size: 12px;
        }

        .calendar-badge-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        /* Day Detail Modal */
        .day-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 150;
            padding: 24px;
        }

        .day-modal.active {
            display: flex;
        }

        .day-detail {
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            width: 100%;
            max-width: 480px;
            max-height: 70vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .day-detail-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .day-detail-title {
            font-size: 18px;
            font-weight: 600;
        }

        .day-detail-content {
            padding: 16px;
            overflow-y: auto;
            flex: 1;
        }

        .day-event-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .day-event-item:hover {
            background: var(--bg-hover);
        }

        .day-event-color {
            width: 4px;
            border-radius: 2px;
            flex-shrink: 0;
        }

        .day-event-info {
            flex: 1;
            min-width: 0;
        }

        .day-event-time {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .day-event-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .no-events {
            text-align: center;
            color: var(--text-muted);
            padding: 40px 20px;
        }

        /* Morning Briefing Modal */
        .briefing-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 250;
            padding: 24px;
        }

        .briefing-modal.active {
            display: flex;
        }

        .briefing-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--accent);
            border-radius: 20px;
            width: 100%;
            max-width: 420px;
            max-height: 70vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px rgba(139, 92, 246, 0.15);
        }

        .briefing-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, transparent 100%);
        }

        .briefing-header-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .briefing-greeting {
            font-size: 14px;
            color: var(--text-muted);
        }

        .briefing-title {
            font-size: 20px;
            font-weight: 600;
        }

        .briefing-date {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .briefing-content {
            padding: 16px;
            overflow-y: auto;
            flex: 1;
        }

        .briefing-event {
            display: flex;
            gap: 12px;
            padding: 14px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            margin-bottom: 10px;
            border-left: 4px solid var(--accent);
        }

        .briefing-event-time {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            color: var(--text-muted);
            min-width: 55px;
            flex-shrink: 0;
        }

        .briefing-event-info {
            flex: 1;
            min-width: 0;
        }

        .briefing-event-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .briefing-event-calendar {
            font-size: 11px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .briefing-event-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .briefing-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .briefing-empty-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .briefing-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-subtle);
            display: flex;
            justify-content: center;
        }

        .briefing-dismiss-btn {
            padding: 10px 32px;
            background: var(--accent);
            border: none;
            border-radius: 10px;
            color: white;
            font-family: inherit;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .briefing-dismiss-btn:hover {
            background: var(--accent-hover);
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--accent);
            border-radius: 16px;
            padding: 16px 20px;
            display: none;
            align-items: flex-start;
            gap: 12px;
            max-width: 360px;
            z-index: 300;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            animation: slideIn 0.3s ease;
        }

        .notification.active {
            display: flex;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification-icon {
            width: 40px;
            height: 40px;
            background: var(--accent);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .notification-content {
            flex: 1;
            min-width: 0;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .notification-time {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .notification-dismiss {
            width: 28px;
            height: 28px;
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-muted);
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-dismiss:hover {
            background: var(--danger);
            color: white;
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
            text-align: center;
            padding: 40px;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state p {
            margin-bottom: 16px;
        }

        /* Permission Banner */
        .permission-banner {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 12px 24px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-subtle);
        }

        .permission-banner.active {
            display: flex;
        }

        .permission-banner p {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .permission-btn {
            padding: 8px 16px;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            color: white;
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
        }

        /* Icons */
        .icon {
            width: 20px;
            height: 20px;
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Permission Banner -->
        <div class="permission-banner" id="permissionBanner">
            <p>Enable notifications to get 30-minute reminders</p>
            <button class="permission-btn" onclick="requestNotificationPermission()">Enable</button>
        </div>

        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <span class="logo">◈ Chronos</span>
                <div class="month-nav">
                    <button class="nav-btn" onclick="navigateMonth(-1)">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                    </button>
                    <span class="current-month" id="currentMonth">January 2026</span>
                    <button class="nav-btn" onclick="navigateMonth(1)">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </button>
                </div>
                <button class="today-btn" onclick="goToToday()">Today</button>
                <div class="view-toggle">
                    <button class="view-toggle-btn active" id="monthViewBtn" onclick="setView('month')">Month</button>
                    <button class="view-toggle-btn" id="weekViewBtn" onclick="setView('week')">Week</button>
                </div>
                <button class="agenda-btn" onclick="triggerMorningBriefing()">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                    </svg>
                    Agenda
                </button>
            </div>
            <div class="header-right">
                <div class="sync-indicator">
                    <span class="sync-dot"></span>
                    <span id="lastSync">Syncing...</span>
                </div>
                <button class="search-btn" onclick="toggleSearch()">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                </button>
                <button class="settings-btn" onclick="toggleSettings()">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Calendar -->
        <div class="calendar-container">
            <div class="weekday-header">
                <div class="weekday">Mon</div>
                <div class="weekday">Tue</div>
                <div class="weekday">Wed</div>
                <div class="weekday">Thu</div>
                <div class="weekday">Fri</div>
                <div class="weekday">Sat</div>
                <div class="weekday">Sun</div>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
        </div>

        <!-- Week View -->
        <div class="week-container" id="weekContainer">
            <div class="week-grid" id="weekGrid"></div>
        </div>
    </div>

    <!-- Search Modal -->
    <div class="search-modal" id="searchModal" onclick="closeSearchOnOverlay(event)">
        <div class="search-panel">
            <div class="search-header">
                <div class="search-input-wrapper">
                    <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                    <input type="text" class="search-input" id="searchInput" placeholder="Search events..." oninput="handleSearch(this.value)">
                </div>
                <button class="close-btn" onclick="toggleSearch()">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="search-results" id="searchResults">
                <div class="search-empty">Type to search events</div>
            </div>
        </div>
    </div>

    <!-- Settings Panel -->
    <div class="settings-overlay" id="settingsOverlay" onclick="closeSettingsOnOverlay(event)">
        <div class="settings-panel">
            <div class="settings-header">
                <h2 class="settings-title">Calendar Settings</h2>
                <button class="close-btn" onclick="toggleSettings()">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="settings-content">
                <p class="section-label">Your Calendars</p>
                <div class="calendar-list" id="calendarList"></div>
                
                <p class="section-label">Add New Calendar</p>
                <div class="add-calendar-form">
                    <div class="input-group">
                        <label class="input-label">iCal URL (Google Calendar secret address)</label>
                        <input type="url" class="text-input" id="newCalUrl" placeholder="https://calendar.google.com/calendar/ical/...">
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label class="input-label">Calendar Name</label>
                            <input type="text" class="text-input" id="newCalName" placeholder="Work, Personal, etc.">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Color</label>
                            <input type="color" class="calendar-color-picker" id="newCalColor" value="#8b5cf6">
                        </div>
                    </div>
                    <button class="add-btn" onclick="addCalendar()">Add Calendar</button>
                </div>

                <div class="reminder-section">
                    <p class="section-label">Reminder Time</p>
                    <select class="reminder-select" id="reminderTime" onchange="updateReminderTime(this.value)">
                        <option value="15">15 minutes before</option>
                        <option value="30" selected>30 minutes before</option>
                        <option value="60">1 hour before</option>
                        <option value="120">2 hours before</option>
                    </select>
                </div>
                
                <div class="privacy-notice">
                    <svg class="privacy-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                    </svg>
                    <div class="privacy-text">
                        <strong>Your data stays local</strong>
                        <span>Calendar URLs are stored only on this device and never sent to any server.</span>
                    </div>
                </div>

                <div class="settings-footer">
                    <p class="credits">
                        Created by <span class="credits-name">Ezekiel Hauge</span><br>
                        <span class="credits-company"><a href="https://eztheory.no" target="_blank" rel="noopener">Eztheory AS</a></span><br>
                        <a href="https://github.com/EzekielNOR/Chronos-Calendar" target="_blank" rel="noopener">GitHub</a> · <a href="https://github.com/EzekielNOR" target="_blank" rel="noopener">@EzekielNOR</a>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Day Detail Modal -->
    <div class="day-modal" id="dayModal" onclick="closeDayModalOnOverlay(event)">
        <div class="day-detail">
            <div class="day-detail-header">
                <h3 class="day-detail-title" id="dayModalTitle">January 1, 2026</h3>
                <button class="close-btn" onclick="closeDayModal()">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="day-detail-content" id="dayModalContent"></div>
        </div>
    </div>

    <!-- Event Detail Modal -->
    <div class="event-modal" id="eventModal" onclick="closeEventModalOnOverlay(event)">
        <div class="event-detail">
            <div class="event-detail-header">
                <h3 class="event-detail-title" id="eventTitle">Event Title</h3>
                <button class="close-btn" onclick="closeEventModal()">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="event-detail-content" id="eventContent"></div>
        </div>
    </div>

    <!-- Morning Briefing Modal -->
    <div class="briefing-modal" id="briefingModal" onclick="closeBriefingOnOverlay(event)">
        <div class="briefing-panel">
            <div class="briefing-header">
                <div class="briefing-header-content">
                    <span class="briefing-greeting">Good morning ☀️</span>
                    <h2 class="briefing-title">Today's Schedule</h2>
                    <span class="briefing-date" id="briefingDate">Thursday, January 30, 2026</span>
                </div>
                <button class="close-btn" onclick="closeBriefing()">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="briefing-content" id="briefingContent"></div>
            <div class="briefing-footer">
                <button class="briefing-dismiss-btn" onclick="closeBriefing()">Got it</button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <div class="notification-icon">
            <svg class="icon" fill="none" stroke="white" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
            </svg>
        </div>
        <div class="notification-content">
            <p class="notification-title" id="notificationTitle">Event Name</p>
            <p class="notification-time" id="notificationTime">Starting in 30 minutes</p>
        </div>
        <button class="notification-dismiss" onclick="dismissNotification()">
            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
        </button>
    </div>

    <!-- Audio for notifications -->
    <audio id="notificationSound" preload="auto">
        <source src="data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAABhgC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAAAAAAAAAAAAYYNBrv+AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/7UGQAD/AAADSAAAAAIAAANIAAAAQAAAaQAAAAgAAA0gAAABExBTUUzLjEwMFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVQ==" type="audio/mp3">
    </audio>

    <script>
        // State
        let calendars = JSON.parse(localStorage.getItem('calendars') || '[]');
        let events = [];
        let currentDate = new Date();
        let currentView = 'month';
        let notifiedEvents = new Set(JSON.parse(localStorage.getItem('notifiedEvents') || '[]'));
        let reminderMinutes = parseInt(localStorage.getItem('reminderMinutes') || '30');

        // CORS Proxy - using a public proxy for iCal fetching
        const CORS_PROXY = 'https://api.allorigins.win/raw?url=';

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // iOS touch fix - make clicks respond immediately
            document.addEventListener('touchstart', function() {}, {passive: true});
            
            // Initialize reminder time from storage
            document.getElementById('reminderTime').value = reminderMinutes;
            
            // Initialize calendar visibility
            calendars.forEach(cal => {
                if (cal.visible === undefined) cal.visible = true;
            });
            
            renderCalendar();
            renderWeekView();
            renderCalendarList();
            fetchAllCalendars();
            checkNotificationPermission();
            
            // Set up swipe navigation
            setupSwipeNavigation();
            
            // Set up refresh interval (every 60 seconds)
            setInterval(fetchAllCalendars, 60000);
            
            // Check for upcoming events every 30 seconds
            setInterval(checkUpcomingEvents, 30000);
            
            // Check for morning briefing every minute
            setInterval(checkMorningBriefing, 60000);
            checkMorningBriefing(); // Check immediately on load
        });

        // Swipe Navigation
        function setupSwipeNavigation() {
            let touchStartX = 0;
            let touchEndX = 0;
            const minSwipeDistance = 50;

            const containers = [
                document.querySelector('.calendar-container'),
                document.getElementById('weekContainer')
            ];

            containers.forEach(container => {
                if (!container) return;
                
                container.addEventListener('touchstart', (e) => {
                    touchStartX = e.changedTouches[0].screenX;
                }, { passive: true });

                container.addEventListener('touchend', (e) => {
                    touchEndX = e.changedTouches[0].screenX;
                    handleSwipe();
                }, { passive: true });
            });

            function handleSwipe() {
                const diff = touchStartX - touchEndX;
                if (Math.abs(diff) < minSwipeDistance) return;

                if (diff > 0) {
                    // Swipe left - next
                    if (currentView === 'month') {
                        navigateMonth(1);
                    } else {
                        navigateWeek(1);
                    }
                } else {
                    // Swipe right - previous
                    if (currentView === 'month') {
                        navigateMonth(-1);
                    } else {
                        navigateWeek(-1);
                    }
                }
            }
        }

        // View Toggle
        function setView(view) {
            currentView = view;
            document.getElementById('monthViewBtn').classList.toggle('active', view === 'month');
            document.getElementById('weekViewBtn').classList.toggle('active', view === 'week');
            document.querySelector('.calendar-container').classList.toggle('hidden', view !== 'month');
            document.getElementById('weekContainer').classList.toggle('active', view === 'week');
            
            if (view === 'week') {
                renderWeekView();
            }
        }

        // Navigation
        function navigateMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            renderCalendar();
            if (currentView === 'week') renderWeekView();
        }

        function navigateWeek(delta) {
            currentDate.setDate(currentDate.getDate() + (delta * 7));
            renderWeekView();
            renderCalendar();
        }

        function goToToday() {
            currentDate = new Date();
            renderCalendar();
            if (currentView === 'week') renderWeekView();
        }

        // Week View
        function renderWeekView() {
            const grid = document.getElementById('weekGrid');
            const monthLabel = document.getElementById('currentMonth');
            
            // Get start of week (Monday)
            const startOfWeek = new Date(currentDate);
            const day = startOfWeek.getDay();
            const diff = startOfWeek.getDate() - day + (day === 0 ? -6 : 1);
            startOfWeek.setDate(diff);
            startOfWeek.setHours(0, 0, 0, 0);

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Update header to show week range
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(endOfWeek.getDate() + 6);
            
            if (currentView === 'week') {
                const startMonth = startOfWeek.toLocaleDateString('en-US', { month: 'short' });
                const endMonth = endOfWeek.toLocaleDateString('en-US', { month: 'short' });
                const year = endOfWeek.getFullYear();
                
                if (startMonth === endMonth) {
                    monthLabel.textContent = `${startMonth} ${startOfWeek.getDate()}-${endOfWeek.getDate()}, ${year}`;
                } else {
                    monthLabel.textContent = `${startMonth} ${startOfWeek.getDate()} - ${endMonth} ${endOfWeek.getDate()}, ${year}`;
                }
            }

            let html = '';
            const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(startOfWeek);
                dayDate.setDate(dayDate.getDate() + i);
                dayDate.setHours(0, 0, 0, 0);
                
                const isToday = dayDate.getTime() === today.getTime();
                const dayEvents = getEventsForDate(dayDate);
                
                const sortedEvents = dayEvents.sort((a, b) => {
                    if (a.allDay && !b.allDay) return -1;
                    if (!a.allDay && b.allDay) return 1;
                    return new Date(a.start) - new Date(b.start);
                });

                html += `
                    <div class="week-day-row ${isToday ? 'today' : ''}" onclick="openDayModal('${dayDate.toISOString()}')">
                        <div class="week-day-info">
                            <span class="week-day-name">${dayNames[i]}</span>
                            <span class="week-day-date">${dayDate.getDate()}</span>
                        </div>
                        <div class="week-events">
                            ${sortedEvents.slice(0, 5).map(event => `
                                <div class="week-event-chip" onclick="event.stopPropagation(); openEventModal('${event.id}')">
                                    <span class="week-event-dot" style="background: ${event.color}"></span>
                                    <span class="week-event-time">${event.allDay ? 'All day' : formatTime(new Date(event.start))}</span>
                                    <span class="week-event-title">${escapeHtml(event.title)}</span>
                                </div>
                            `).join('')}
                            ${sortedEvents.length > 5 ? `<span class="more-events">+${sortedEvents.length - 5} more</span>` : ''}
                        </div>
                    </div>
                `;
            }

            grid.innerHTML = html;
        }

        // Render Calendar Grid
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthLabel = document.getElementById('currentMonth');
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            monthLabel.textContent = new Date(year, month, 1).toLocaleDateString('en-US', { 
                month: 'long', 
                year: 'numeric' 
            });

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDay = (firstDay.getDay() + 6) % 7; // Adjust for Monday start
            const daysInMonth = lastDay.getDate();

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let html = '';
            let dayCount = 1;
            let nextMonthDay = 1;

            // Previous month days
            const prevMonthLastDay = new Date(year, month, 0).getDate();

            for (let i = 0; i < 42; i++) {
                let dayNumber, isOtherMonth = false, dateStr;
                
                if (i < startDay) {
                    dayNumber = prevMonthLastDay - startDay + i + 1;
                    isOtherMonth = true;
                    dateStr = `${year}-${String(month).padStart(2, '0')}-${String(dayNumber).padStart(2, '0')}`;
                } else if (dayCount <= daysInMonth) {
                    dayNumber = dayCount++;
                    dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(dayNumber).padStart(2, '0')}`;
                } else {
                    dayNumber = nextMonthDay++;
                    isOtherMonth = true;
                    dateStr = `${year}-${String(month + 2).padStart(2, '0')}-${String(dayNumber).padStart(2, '0')}`;
                }

                const cellDate = new Date(year, i < startDay ? month - 1 : (dayCount - 1 <= daysInMonth ? month : month + 1), dayNumber);
                cellDate.setHours(0, 0, 0, 0);
                const isToday = cellDate.getTime() === today.getTime();
                
                const dayEvents = getEventsForDate(cellDate);
                
                html += `
                    <div class="day-cell ${isOtherMonth ? 'other-month' : ''} ${isToday ? 'today' : ''}" 
                         onclick="openDayModal('${cellDate.toISOString()}')">
                        <span class="day-number">${dayNumber}</span>
                        <div class="events-list">
                            ${renderDayEvents(dayEvents)}
                        </div>
                    </div>
                `;
            }

            grid.innerHTML = html;
        }

        function renderDayEvents(dayEvents) {
            const maxEvents = 3;
            let html = '';
            
            const sortedEvents = dayEvents.sort((a, b) => {
                if (a.allDay && !b.allDay) return -1;
                if (!a.allDay && b.allDay) return 1;
                return new Date(a.start) - new Date(b.start);
            });

            const displayEvents = sortedEvents.slice(0, maxEvents);
            const remaining = sortedEvents.length - maxEvents;

            displayEvents.forEach(event => {
                const timeStr = event.allDay ? 'All day' : formatTime(new Date(event.start));
                html += `
                    <div class="event-item" onclick="event.stopPropagation(); openEventModal('${event.id}')">
                        <span class="event-color" style="background: ${event.color}"></span>
                        <span class="event-time">${timeStr}</span>
                        <span class="event-title">${escapeHtml(event.title)}</span>
                    </div>
                `;
            });

            if (remaining > 0) {
                html += `<div class="more-events">+${remaining} more</div>`;
            }

            return html;
        }

        function getEventsForDate(date) {
            const dateStart = new Date(date);
            dateStart.setHours(0, 0, 0, 0);
            const dateEnd = new Date(date);
            dateEnd.setHours(23, 59, 59, 999);

            return events.filter(event => {
                // Check calendar visibility
                const cal = calendars.find(c => c.id === event.calendarId);
                if (cal && cal.visible === false) return false;
                
                const eventStart = new Date(event.start);
                const eventEnd = new Date(event.end || event.start);
                
                // Check if event overlaps with this day
                return eventStart <= dateEnd && eventEnd >= dateStart;
            });
        }

        // Calendar Management
        function renderCalendarList() {
            const list = document.getElementById('calendarList');
            
            if (calendars.length === 0) {
                list.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 20px;">No calendars added yet</p>';
                return;
            }

            list.innerHTML = calendars.map((cal, index) => `
                <div class="calendar-item">
                    <label class="calendar-toggle">
                        <input type="checkbox" ${cal.visible !== false ? 'checked' : ''} 
                               onchange="toggleCalendarVisibility(${index}, this.checked)">
                        <span class="calendar-toggle-slider"></span>
                    </label>
                    <input type="color" class="calendar-color-picker" value="${cal.color}" 
                           onchange="updateCalendarColor(${index}, this.value)">
                    <div class="calendar-info">
                        <input type="text" class="calendar-name-input" value="${escapeHtml(cal.name)}" 
                               onchange="updateCalendarName(${index}, this.value)">
                        <div class="calendar-url">${escapeHtml(cal.url.substring(0, 40))}...</div>
                    </div>
                    <button class="delete-cal-btn" onclick="deleteCalendar(${index})">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                    </button>
                </div>
            `).join('');
        }

        function toggleCalendarVisibility(index, visible) {
            calendars[index].visible = visible;
            localStorage.setItem('calendars', JSON.stringify(calendars));
            renderCalendar();
            if (currentView === 'week') renderWeekView();
        }

        function addCalendar() {
            const url = document.getElementById('newCalUrl').value.trim();
            const name = document.getElementById('newCalName').value.trim() || 'Unnamed Calendar';
            const color = document.getElementById('newCalColor').value;

            if (!url) {
                alert('Please enter an iCal URL');
                return;
            }

            calendars.push({ url, name, color, id: Date.now().toString(), visible: true });
            localStorage.setItem('calendars', JSON.stringify(calendars));
            
            document.getElementById('newCalUrl').value = '';
            document.getElementById('newCalName').value = '';
            
            renderCalendarList();
            fetchAllCalendars();
        }

        function updateCalendarColor(index, color) {
            calendars[index].color = color;
            localStorage.setItem('calendars', JSON.stringify(calendars));
            updateEventColors();
            renderCalendar();
        }

        function updateCalendarName(index, name) {
            calendars[index].name = name;
            localStorage.setItem('calendars', JSON.stringify(calendars));
        }

        function deleteCalendar(index) {
            if (confirm('Delete this calendar?')) {
                calendars.splice(index, 1);
                localStorage.setItem('calendars', JSON.stringify(calendars));
                renderCalendarList();
                fetchAllCalendars();
            }
        }

        function updateEventColors() {
            events.forEach(event => {
                const cal = calendars.find(c => c.id === event.calendarId);
                if (cal) {
                    event.color = cal.color;
                }
            });
        }

        // iCal Fetching
        async function fetchAllCalendars() {
            if (calendars.length === 0) {
                events = [];
                renderCalendar();
                updateSyncStatus();
                return;
            }

            try {
                const allEvents = [];
                
                for (const cal of calendars) {
                    try {
                        const calEvents = await fetchCalendar(cal);
                        allEvents.push(...calEvents);
                    } catch (err) {
                        console.error(`Error fetching ${cal.name}:`, err);
                    }
                }

                events = allEvents;
                renderCalendar();
                updateSyncStatus();
            } catch (err) {
                console.error('Error fetching calendars:', err);
            }
        }

        async function fetchCalendar(cal) {
            const response = await fetch(CORS_PROXY + encodeURIComponent(cal.url));
            const icalText = await response.text();
            return parseIcal(icalText, cal);
        }

        function parseIcal(icalText, cal) {
            const events = [];
            const lines = icalText.split(/\r?\n/);
            let currentEvent = null;
            let currentKey = '';
            let currentValue = '';

            for (let i = 0; i < lines.length; i++) {
                let line = lines[i];
                
                // Handle line folding (lines starting with space/tab are continuations)
                if (line.startsWith(' ') || line.startsWith('\t')) {
                    currentValue += line.substring(1);
                    continue;
                }

                // Process previous key-value pair
                if (currentKey && currentEvent) {
                    processIcalProperty(currentEvent, currentKey, currentValue);
                }

                // Parse new line
                const colonIndex = line.indexOf(':');
                if (colonIndex === -1) continue;

                currentKey = line.substring(0, colonIndex);
                currentValue = line.substring(colonIndex + 1);

                if (line.startsWith('BEGIN:VEVENT')) {
                    currentEvent = {
                        id: '',
                        title: '',
                        start: null,
                        end: null,
                        location: '',
                        description: '',
                        allDay: false,
                        color: cal.color,
                        calendarId: cal.id,
                        calendarName: cal.name
                    };
                } else if (line.startsWith('END:VEVENT') && currentEvent) {
                    if (currentEvent.start) {
                        if (!currentEvent.id) {
                            currentEvent.id = `${cal.id}-${currentEvent.start}-${currentEvent.title}`;
                        }
                        events.push(currentEvent);
                    }
                    currentEvent = null;
                    currentKey = '';
                    currentValue = '';
                }
            }

            return events;
        }

        function processIcalProperty(event, key, value) {
            // Remove parameters from key (e.g., "DTSTART;VALUE=DATE" -> "DTSTART")
            const baseKey = key.split(';')[0];
            
            switch (baseKey) {
                case 'UID':
                    event.id = value;
                    break;
                case 'SUMMARY':
                    event.title = unescapeIcal(value);
                    break;
                case 'DTSTART':
                    const startResult = parseIcalDate(key, value);
                    event.start = startResult.date;
                    event.allDay = startResult.allDay;
                    break;
                case 'DTEND':
                    event.end = parseIcalDate(key, value).date;
                    break;
                case 'LOCATION':
                    event.location = unescapeIcal(value);
                    break;
                case 'DESCRIPTION':
                    event.description = unescapeIcal(value);
                    break;
            }
        }

        function parseIcalDate(key, value) {
            const isDateOnly = key.includes('VALUE=DATE') && !key.includes('VALUE=DATE-TIME');
            let date;

            if (isDateOnly || value.length === 8) {
                // Date only: YYYYMMDD
                const year = parseInt(value.substring(0, 4));
                const month = parseInt(value.substring(4, 6)) - 1;
                const day = parseInt(value.substring(6, 8));
                date = new Date(year, month, day);
                return { date: date.toISOString(), allDay: true };
            } else {
                // Date-time: YYYYMMDDTHHMMSS or YYYYMMDDTHHMMSSZ
                const year = parseInt(value.substring(0, 4));
                const month = parseInt(value.substring(4, 6)) - 1;
                const day = parseInt(value.substring(6, 8));
                const hour = parseInt(value.substring(9, 11));
                const minute = parseInt(value.substring(11, 13));
                const second = parseInt(value.substring(13, 15)) || 0;
                
                if (value.endsWith('Z')) {
                    date = new Date(Date.UTC(year, month, day, hour, minute, second));
                } else {
                    date = new Date(year, month, day, hour, minute, second);
                }
                return { date: date.toISOString(), allDay: false };
            }
        }

        function unescapeIcal(text) {
            return text
                .replace(/\\n/g, '\n')
                .replace(/\\,/g, ',')
                .replace(/\\;/g, ';')
                .replace(/\\\\/g, '\\');
        }

        function updateSyncStatus() {
            const syncEl = document.getElementById('lastSync');
            syncEl.textContent = `Synced ${new Date().toLocaleTimeString()}`;
        }

        // Modals
        function toggleSettings() {
            document.getElementById('settingsOverlay').classList.toggle('active');
        }

        function closeSettingsOnOverlay(e) {
            if (e.target === e.currentTarget) {
                toggleSettings();
            }
        }

        function openDayModal(dateStr) {
            const date = new Date(dateStr);
            const dayEvents = getEventsForDate(date);
            
            document.getElementById('dayModalTitle').textContent = date.toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'long',
                day: 'numeric',
                year: 'numeric'
            });

            const content = document.getElementById('dayModalContent');
            
            if (dayEvents.length === 0) {
                content.innerHTML = '<div class="no-events">No events this day</div>';
            } else {
                const sortedEvents = dayEvents.sort((a, b) => {
                    if (a.allDay && !b.allDay) return -1;
                    if (!a.allDay && b.allDay) return 1;
                    return new Date(a.start) - new Date(b.start);
                });

                content.innerHTML = sortedEvents.map(event => {
                    const timeStr = event.allDay ? 'All day' : 
                        `${formatTime(new Date(event.start))}${event.end ? ' - ' + formatTime(new Date(event.end)) : ''}`;
                    
                    return `
                        <div class="day-event-item" onclick="openEventModal('${event.id}')">
                            <div class="day-event-color" style="background: ${event.color}"></div>
                            <div class="day-event-info">
                                <div class="day-event-time">${timeStr}</div>
                                <div class="day-event-title">${escapeHtml(event.title)}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            document.getElementById('dayModal').classList.add('active');
        }

        function closeDayModal() {
            document.getElementById('dayModal').classList.remove('active');
        }

        function closeDayModalOnOverlay(e) {
            if (e.target === e.currentTarget) {
                closeDayModal();
            }
        }

        function openEventModal(eventId) {
            const event = events.find(e => e.id === eventId);
            if (!event) return;

            document.getElementById('eventTitle').textContent = event.title;

            const startDate = new Date(event.start);
            const endDate = event.end ? new Date(event.end) : null;

            let dateTimeHtml = '';
            if (event.allDay) {
                dateTimeHtml = startDate.toLocaleDateString('en-US', {
                    weekday: 'long',
                    month: 'long',
                    day: 'numeric',
                    year: 'numeric'
                });
                if (endDate && endDate.toDateString() !== startDate.toDateString()) {
                    dateTimeHtml += ' - ' + endDate.toLocaleDateString('en-US', {
                        weekday: 'long',
                        month: 'long',
                        day: 'numeric',
                        year: 'numeric'
                    });
                }
            } else {
                dateTimeHtml = startDate.toLocaleDateString('en-US', {
                    weekday: 'long',
                    month: 'long',
                    day: 'numeric',
                    year: 'numeric'
                });
                dateTimeHtml += '<br>' + formatTime(startDate);
                if (endDate) {
                    dateTimeHtml += ' - ' + formatTime(endDate);
                }
            }

            let html = `
                <div class="detail-row">
                    <svg class="detail-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    <div>
                        <div class="detail-label">Date & Time</div>
                        <div class="detail-text">${dateTimeHtml}</div>
                    </div>
                </div>
            `;

            if (event.location) {
                html += `
                    <div class="detail-row">
                        <svg class="detail-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        <div>
                            <div class="detail-label">Location</div>
                            <div class="detail-text">${escapeHtml(event.location)}</div>
                        </div>
                    </div>
                `;
            }

            html += `
                <div class="detail-row">
                    <svg class="detail-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                    </svg>
                    <div>
                        <div class="detail-label">Calendar</div>
                        <span class="calendar-badge">
                            <span class="calendar-badge-dot" style="background: ${event.color}"></span>
                            ${escapeHtml(event.calendarName)}
                        </span>
                    </div>
                </div>
            `;

            if (event.description) {
                html += `
                    <div class="detail-row">
                        <svg class="detail-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"/>
                        </svg>
                        <div>
                            <div class="detail-label">Description</div>
                            <div class="detail-text">${escapeHtml(event.description).replace(/\n/g, '<br>')}</div>
                        </div>
                    </div>
                `;
            }

            document.getElementById('eventContent').innerHTML = html;
            document.getElementById('eventModal').classList.add('active');
        }

        function closeEventModal() {
            document.getElementById('eventModal').classList.remove('active');
        }

        function closeEventModalOnOverlay(e) {
            if (e.target === e.currentTarget) {
                closeEventModal();
            }
        }

        // Notifications
        function checkNotificationPermission() {
            if ('Notification' in window) {
                if (Notification.permission === 'default') {
                    document.getElementById('permissionBanner').classList.add('active');
                }
            }
        }

        async function requestNotificationPermission() {
            if ('Notification' in window) {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    document.getElementById('permissionBanner').classList.remove('active');
                }
            }
        }

        function checkUpcomingEvents() {
            const now = new Date();
            const reminderMs = reminderMinutes * 60 * 1000;
            const reminderFromNow = new Date(now.getTime() + reminderMs);
            const reminderWindowStart = new Date(now.getTime() + reminderMs - 60000); // 1 min window

            events.forEach(event => {
                if (event.allDay) return;
                
                // Check calendar visibility
                const cal = calendars.find(c => c.id === event.calendarId);
                if (cal && cal.visible === false) return;
                
                const eventStart = new Date(event.start);
                const notificationKey = `${event.id}-${eventStart.toISOString()}-${reminderMinutes}`;
                
                // Check if event starts in approximately reminderMinutes (1 min window)
                if (eventStart > reminderWindowStart && 
                    eventStart <= reminderFromNow && 
                    !notifiedEvents.has(notificationKey)) {
                    
                    showNotification(event);
                    notifiedEvents.add(notificationKey);
                    
                    // Save to localStorage (keep only last 100)
                    const notifiedArray = Array.from(notifiedEvents).slice(-100);
                    localStorage.setItem('notifiedEvents', JSON.stringify(notifiedArray));
                }
            });
        }

        function showNotification(event) {
            // Play sound
            const audio = document.getElementById('notificationSound');
            audio.currentTime = 0;
            audio.play().catch(() => {});

            // Show in-app notification
            const notification = document.getElementById('notification');
            document.getElementById('notificationTitle').textContent = event.title;
            const timeLabel = reminderMinutes >= 60 
                ? `Starting in ${reminderMinutes / 60} hour${reminderMinutes > 60 ? 's' : ''}`
                : `Starting in ${reminderMinutes} minutes`;
            document.getElementById('notificationTime').textContent = timeLabel;
            notification.classList.add('active');

            // Auto-dismiss after 10 seconds
            setTimeout(() => {
                dismissNotification();
            }, 10000);

            // Also show browser notification if permitted
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('Upcoming Event', {
                    body: `${event.title} starts at ${formatTime(new Date(event.start))}`,
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%238b5cf6"><rect width="24" height="24" rx="4"/></svg>',
                    tag: event.id
                });
            }
        }

        function dismissNotification() {
            document.getElementById('notification').classList.remove('active');
        }

        // Morning Briefing
        let lastBriefingDate = localStorage.getItem('lastBriefingDate') || '';

        function checkMorningBriefing() {
            const now = new Date();
            const today = now.toDateString();
            const hour = now.getHours();
            const minute = now.getMinutes();

            // Trigger at 7:00 AM if not already shown today
            if (hour === 7 && minute === 0 && lastBriefingDate !== today) {
                showMorningBriefing();
            }
        }

        function showMorningBriefing() {
            const now = new Date();
            const today = now.toDateString();
            
            // Mark as shown for today
            lastBriefingDate = today;
            localStorage.setItem('lastBriefingDate', today);

            // Update date display
            document.getElementById('briefingDate').textContent = now.toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'long',
                day: 'numeric',
                year: 'numeric'
            });

            // Get today's events
            const todayEvents = getEventsForDate(now);
            const content = document.getElementById('briefingContent');

            if (todayEvents.length === 0) {
                content.innerHTML = `
                    <div class="briefing-empty">
                        <div class="briefing-empty-icon">📭</div>
                        <p>No events scheduled for today</p>
                        <p style="font-size: 13px; margin-top: 8px;">Enjoy your free day!</p>
                    </div>
                `;
            } else {
                const sortedEvents = todayEvents.sort((a, b) => {
                    if (a.allDay && !b.allDay) return -1;
                    if (!a.allDay && b.allDay) return 1;
                    return new Date(a.start) - new Date(b.start);
                });

                content.innerHTML = sortedEvents.map(event => {
                    const timeStr = event.allDay ? 'All day' : formatTime(new Date(event.start));
                    return `
                        <div class="briefing-event" style="border-left-color: ${event.color}">
                            <span class="briefing-event-time">${timeStr}</span>
                            <div class="briefing-event-info">
                                <div class="briefing-event-title">${escapeHtml(event.title)}</div>
                                <div class="briefing-event-calendar">
                                    <span class="briefing-event-dot" style="background: ${event.color}"></span>
                                    ${escapeHtml(event.calendarName)}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Play notification sound
            const audio = document.getElementById('notificationSound');
            audio.currentTime = 0;
            audio.play().catch(() => {});

            // Show the modal
            document.getElementById('briefingModal').classList.add('active');

            // Also trigger browser notification if permitted
            if ('Notification' in window && Notification.permission === 'granted') {
                const eventCount = todayEvents.length;
                new Notification('Good Morning!', {
                    body: eventCount > 0 
                        ? `You have ${eventCount} event${eventCount > 1 ? 's' : ''} scheduled today`
                        : 'No events scheduled for today',
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%238b5cf6"><rect width="24" height="24" rx="4"/></svg>',
                    tag: 'morning-briefing'
                });
            }
        }

        function closeBriefing() {
            document.getElementById('briefingModal').classList.remove('active');
        }

        function closeBriefingOnOverlay(e) {
            if (e.target === e.currentTarget) {
                closeBriefing();
            }
        }

        // Manual trigger for testing (can be called from console)
        function triggerMorningBriefing() {
            showMorningBriefing();
        }

        // Search functionality
        function toggleSearch() {
            const modal = document.getElementById('searchModal');
            modal.classList.toggle('active');
            if (modal.classList.contains('active')) {
                document.getElementById('searchInput').focus();
            } else {
                document.getElementById('searchInput').value = '';
                document.getElementById('searchResults').innerHTML = '<div class="search-empty">Type to search events</div>';
            }
        }

        function closeSearchOnOverlay(e) {
            if (e.target === e.currentTarget) {
                toggleSearch();
            }
        }

        function handleSearch(query) {
            const results = document.getElementById('searchResults');
            
            if (!query.trim()) {
                results.innerHTML = '<div class="search-empty">Type to search events</div>';
                return;
            }

            const searchTerm = query.toLowerCase();
            const matchingEvents = events.filter(event => {
                // Check calendar visibility
                const cal = calendars.find(c => c.id === event.calendarId);
                if (cal && cal.visible === false) return false;
                
                return event.title.toLowerCase().includes(searchTerm) ||
                       (event.description && event.description.toLowerCase().includes(searchTerm)) ||
                       (event.location && event.location.toLowerCase().includes(searchTerm));
            });

            // Sort by date (upcoming first)
            matchingEvents.sort((a, b) => new Date(a.start) - new Date(b.start));

            if (matchingEvents.length === 0) {
                results.innerHTML = '<div class="search-empty">No events found</div>';
                return;
            }

            results.innerHTML = matchingEvents.slice(0, 20).map(event => {
                const eventDate = new Date(event.start);
                const dateStr = eventDate.toLocaleDateString('en-US', {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric'
                });
                const timeStr = event.allDay ? 'All day' : formatTime(eventDate);
                
                return `
                    <div class="search-result-item" onclick="openEventFromSearch('${event.id}', '${eventDate.toISOString()}')">
                        <div class="search-result-color" style="background: ${event.color}"></div>
                        <div class="search-result-info">
                            <div class="search-result-title">${escapeHtml(event.title)}</div>
                            <div class="search-result-date">${dateStr} · ${timeStr}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openEventFromSearch(eventId, dateStr) {
            toggleSearch();
            currentDate = new Date(dateStr);
            renderCalendar();
            if (currentView === 'week') renderWeekView();
            setTimeout(() => openEventModal(eventId), 100);
        }

        // Reminder time
        function updateReminderTime(minutes) {
            reminderMinutes = parseInt(minutes);
            localStorage.setItem('reminderMinutes', minutes);
        }

        // Utilities
        function formatTime(date) {
            return date.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            });
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
